<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expenses Dashboard</title>
    <style>
        body, html {
            background: #101010;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }
        .expenses-dashboard {
            background-color: #101010;
            padding: 20px 20px 20px 80px;
        }
        @media (max-width: 991px) {
            .expenses-dashboard {
                padding-left: 20px;
            }
        }
        .dashboard-layout {
            display: flex;
            gap: 20px;
        }
        @media (max-width: 991px) {
            .dashboard-layout {
                flex-direction: column;
                align-items: stretch;
                gap: 0;
            }
        }
        .sidebar {
            display: flex;
            flex-direction: column;
            width: 15%;
            margin-left: 0;
        }
        @media (max-width: 991px) {
            .sidebar {
                width: 100%;
            }
        }
        .user-profile {
            display: flex;
            margin-top: 45px;
            flex-direction: column;
            font: 600 25px/140% Poppins, sans-serif;
            color: #fff;
        }
        @media (max-width: 991px) {
            .user-profile {
                margin-top: 40px;
            }
        }
        .profile-picture {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
        }
        .username {
            margin-top: 26px;
            font: 30px/117% Poppins, sans-serif;
        }
        .user-email {
            margin-top: 15px;
            font: 400 17px/159% Poppins, sans-serif;
            color: #a0a0a0;
        }
        .nav-menu {
            list-style-type: none;
            padding: 0;
            margin-top: 40px;
        }
        .nav-item {
            font: 600 18px/140% Poppins, sans-serif;
            margin-bottom: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        .nav-item:hover {
            background-color: #2c2c2c;
        }
        .nav-item a {
            text-decoration: none;
            color: white;
            display: block;
        }
        .main-content {
            display: flex;
            flex-direction: column;
            width: 85%;
            margin-left: 20px;
        }
        @media (max-width: 991px) {
            .main-content {
                width: 100%;
            }
        }
        .content-wrapper {
            border-radius: 30px;
            background-color: #fff;
            flex-grow: 1;
            padding-left: 80px;
            width: 100%;
        }
        @media (max-width: 991px) {
            .content-wrapper {
                max-width: 100%;
                margin-top: 40px;
            }
        }
        .content-layout {
            display: flex;
            gap: 20px;
        }
        @media (max-width: 991px) {
            .content-layout {
                flex-direction: column;
                align-items: stretch;
                gap: 0;
            }
        }
        .expenses-section {
            display: flex;
            flex-direction: column;
            width: 59%;
            margin-left: 0;
        }
        @media (max-width: 991px) {
            .expenses-section {
                width: 100%;
            }
        }
        .expenses-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        @media (max-width: 991px) {
            .expenses-header {
                max-width: 100%;
                flex-wrap: wrap;
            }
        }
        .header-text {
            display: flex;
            flex-direction: column;
        }
        .expenses-title {
            color: #262a41;
            letter-spacing: 0.67px;
            font: 600 40px Poppins, sans-serif;
        }
        .expenses-date {
            color: #101010;
            letter-spacing: 0.34px;
            margin-top: 16px;
            font: 400 16px Poppins, sans-serif;
        }
        .header-icon {
            aspect-ratio: 4;
            object-fit: auto;
            object-position: center;
            width: 123px;
            align-self: start;
            max-width: 100%;
        }
        .expenses-chart {
            aspect-ratio: 8.33;
            object-fit: auto;
            object-position: center;
            width: 510px;
            align-self: center;
            margin-top: 50px;
        }
        @media (max-width: 991px) {
            .expenses-chart {
                max-width: 100%;
                margin-top: 40px;
            }
        }
        .expenses-list {
            margin-top: 54px;
        }
        @media (max-width: 991px) {
            .expenses-list {
                max-width: 100%;
                margin-top: 40px;
            }
        }
        .expenses-layout {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        @media (max-width: 991px) {
            .expenses-layout {
                flex-direction: column;
                align-items: stretch;
            }
        }
        .expenses-items {
            display: flex;
            flex-direction: column;
            width: 70%;
        }
        @media (max-width: 991px) {
            .expenses-items {
                width: 100%;
                margin-top: 40px;
            }
        }
        .expense-date {
            color: #262a41;
            letter-spacing: 0.3px;
            font: 400 18px/167% AvenirNext, sans-serif;
            margin-bottom: 20px;
        }
        .expense-item {
            display: flex;
            margin-bottom: 25px;
            gap: 17px;
            align-items: center;
            justify-content: space-between;
        }
        .expense-icon {
            width: 35px;
            height: 40px;
            margin-right: 10px;
        }
        .expense-details {
            flex: 1;
        }
        .expense-category {
            color: #273240;
            letter-spacing: 0.34px;
            font: 500 16px Poppins, sans-serif;
            margin: 0;
        }
        .expense-description {
            color: #404852;
            letter-spacing: 0.5px;
            margin: 5px 0 0;
            font: 400 14px Poppins, sans-serif;
        }
        .expenses-amounts {
            display: flex;
            flex-direction: column;
            font: 600 16px Poppins, sans-serif;
            color: #273240;
            text-align: right;
            letter-spacing: 0.34px;
            width: 25%;
            margin-left: 20px;
        }
        @media (max-width: 991px) {
            .expenses-amounts {
                width: 100%;
                margin-top: 40px;
            }
        }
        .amount-icon {
            aspect-ratio: 5;
            object-fit: auto;
            object-position: center;
            width: 25px;
            align-self: flex-end;
            margin-bottom: 10px;
        }
        .amount {
            margin: 25px 0;
        }
        .sidebar-content {
            border-radius: 0;
            background-color: #f9fafc;
            display: flex;
            width: 100%;
            flex-grow: 1;
            flex-direction: column;
            margin: 0 auto;
            padding: 70px 50px;
        }
        @media (max-width: 991px) {
            .sidebar-content {
                margin-top: 40px;
                padding: 0 20px;
            }
        }
        .sidebar-title {
            color: #262a41;
            letter-spacing: 0.33px;
            font: 400 20px/150% AvenirNext, sans-serif;
        }
        .expense-category-item {
            display: flex;
            margin-top: 37px;
            gap: 20px;
            font: 500 13px/185% Poppins, sans-serif;
            color: #273240;
            letter-spacing: 0.46px;
            justify-content: space-between;
        }
        .category-name {
            font-weight: 500;
        }
        .category-amount {
            text-align: right;
            font-weight: 400;
        }
        .progress-bar {
            border-radius: 5px;
            background-color: #eceff5;
            display: flex;
            margin-top: 11px;
            flex-direction: column;
            justify-content: center;
        }
        .progress-fill {
            border-radius: 5px;
            background-color: #31ba96;
            height: 5px;
        }
        .savings-tip {
            border-radius: 15px;
            background-color: #edf0f6;
            display: flex;
            margin-top: 101px;
            width: 100%;
            flex-direction: column;
            padding: 0 25px 25px;
        }
        @media (max-width: 991px) {
            .savings-tip {
                margin-top: 40px;
                padding: 0 20px;
            }
        }
        .tip-icons {
            z-index: 10;
            display: flex;
            margin-top: -34px;
            gap: 20px;
            justify-content: space-between;
        }
        .tip-icon-left {
            aspect-ratio: 1.16;
            object-fit: auto;
            object-position: center;
            width: 84px;
            align-self: start;
            margin-top: 19px;
        }
        .tip-icon-right {
            aspect-ratio: 0.59;
            object-fit: auto;
            object-position: center;
            width: 53px;
        }
        .tip-title {
            color: #273240;
            letter-spacing: 0.34px;
            margin-top: 27px;
            font: 600 16px Poppins, sans-serif;
        }
        .tip-description {
            color: #404852;
            letter-spacing: 0.43px;
            margin-top: 12px;
            font: 400 12px/21px Poppins, sans-serif;
        }
        .tip-button {
            border-radius: 8px;
            background-color: #101010;
            margin-top: 26px;
            color: #fff;
            letter-spacing: 1.5px;
            justify-content: center;
            padding: 18px 60px;
            font: 600 13px Poppins, sans-serif;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .tip-button:hover {
            background-color: #2c2c2c;
        }
        @media (max-width: 991px) {
            .tip-button {
                padding: 0 24px 0 22px;
            }
        }
        #expensesChart {
            width: 100%;
            height: 300px;
        }
        .bar {
            fill: #31ba96;
            cursor: pointer;
            transition: fill 0.3s ease;
        }
        .bar:hover {
            fill: #2a9d7c;
        }
        .bar-label {
            fill: #262a41;
            font-size: 12px;
            text-anchor: middle;
        }
        /* Style the select element */
#year-select {
    display: block;
    width: 100%;
    padding: 0.5em;
    margin: 1em 0;
    font-size: 1em;
    line-height: 1.5;
    border: 1px solid #ccc;
    border-radius: 0.25em;
    background-color: #f9f9f9;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns%3D%22http%3A//www.w3.org/2000/svg%22 viewBox%3D%220 0 4 5%22%3E%3Cpath fill%3D%22%23333%22 d%3D%22M2 0L0 2h4L2 0zM2 5L0 3h4L2 5z%22/%3E%3C/svg%3E');
    background-repeat: no-repeat;
    background-position: right 0.5em top 50%;
    background-size: 1em;
}

#year-select:focus {
    border-color: #66afe9;
    outline: 0;
    box-shadow: 0 0 5px rgba(102, 175, 233, 0.5);
}

#year-select option {
    padding: 0.5em;
}

/* Additional styling for the dropdown container */
.dropdown-container {
    position: relative;
    display: inline-block;
    width: 100%;
}

/* General responsive adjustments */
@media (max-width: 1200px) {
    .expenses-dashboard {
        padding-left: 40px; /* Reduce left padding for medium-large screens */
    }
}

@media (max-width: 991px) {
    .expenses-dashboard {
        padding-left: 20px; /* Reduce left padding for medium screens */
    }

    .dashboard-layout {
        flex-direction: column;
        align-items: stretch;
        gap: 0;
    }

    .sidebar {
        width: 100%; /* Full width for sidebar on medium screens */
    }

    .main-content {
        width: 100%; /* Full width for main content on medium screens */
    }

    .content-wrapper {
        padding-left: 20px; /* Reduce padding for content wrapper */
    }

    .content-layout {
        flex-direction: column;
        align-items: stretch;
        gap: 0;
    }

    .expenses-section {
        width: 100%; /* Full width for expenses section */
    }

    .expenses-header {
        flex-wrap: wrap; /* Wrap header elements for medium screens */
    }

    .expenses-chart {
        max-width: 100%; /* Full width for chart on medium screens */
    }

    .expenses-list {
        max-width: 100%; /* Full width for list on medium screens */
    }

    .expenses-items {
        width: 100%; /* Full width for expenses items */
    }

    .expenses-amounts {
        width: 100%; /* Full width for amounts */
    }

    .sidebar-content {
        padding: 0 20px; /* Reduce padding for sidebar content */
    }

    .savings-tip {
        margin-top: 40px; /* Adjust margin for savings tips */
        padding: 0 20px; /* Reduce padding for tips container */
    }

    .tip-button {
        padding: 0 24px; /* Adjust padding for tip button */
    }
}

@media (max-width: 768px) {
    .user-profile {
        margin-top: 30px; /* Adjust margin for user profile */
    }

    .username {
        font-size: 24px; /* Adjust font size for username */
    }

    .user-email {
        font-size: 14px; /* Adjust font size for user email */
    }

    .header-text {
        font-size: 16px; /* Adjust font size for header text */
    }

    .expenses-title {
        font-size: 32px; /* Adjust font size for expenses title */
    }

    .expenses-date {
        font-size: 14px; /* Adjust font size for expenses date */
    }

    .header-icon {
        width: 100px; /* Adjust width for header icon */
    }

    .expenses-chart {
        height: 250px; /* Adjust height for chart */
    }

    .expense-date {
        font-size: 16px; /* Adjust font size for expense date */
    }

    .expense-category {
        font-size: 14px; /* Adjust font size for expense category */
    }

    .expense-description {
        font-size: 12px; /* Adjust font size for expense description */
    }

    .expenses-amounts {
        font-size: 14px; /* Adjust font size for amounts */
    }

    .amount-icon {
        width: 20px; /* Adjust width for amount icon */
    }

    .tip-title {
        font-size: 14px; /* Adjust font size for tip title */
    }

    .tip-description {
        font-size: 11px; /* Adjust font size for tip description */
    }
}

@media (max-width: 576px) {
    .user-profile {
        margin-top: 20px; /* Further adjust margin for user profile */
    }

    .username {
        font-size: 20px; /* Further reduce font size for username */
    }

    .user-email {
        font-size: 12px; /* Further reduce font size for user email */
    }

    .expenses-title {
        font-size: 28px; /* Further reduce font size for expenses title */
    }

    .expenses-date {
        font-size: 12px; /* Further reduce font size for expenses date */
    }

    .header-icon {
        width: 80px; /* Further adjust width for header icon */
    }

    .expenses-chart {
        height: 200px; /* Further adjust height for chart */
    }

    .expense-date {
        font-size: 14px; /* Further reduce font size for expense date */
    }

    .expense-category {
        font-size: 12px; /* Further reduce font size for expense category */
    }

    .expense-description {
        font-size: 10px; /* Further reduce font size for expense description */
    }

    .expenses-amounts {
        font-size: 12px; /* Further reduce font size for amounts */
    }

    .amount-icon {
        width: 15px; /* Further adjust width for amount icon */
    }

    .tip-title {
        font-size: 12px; /* Further reduce font size for tip title */
    }

    .tip-description {
        font-size: 10px; /* Further reduce font size for tip description */
    }
}

/* Ensure select element is responsive */
@media (max-width: 576px) {
    #year-select {
        font-size: 0.9em; /* Adjust font size for select element on small screens */
    }
}


    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

</head>
<body>
    <section class="expenses-dashboard">
        <div class="dashboard-layout">
            <aside class="sidebar">
                <div class="user-profile">
                    <img src="{% if profile.image %}{{ profile.image.url }}{% else %}https://www.pngitem.com/pimgs/m/78-786293_1240-x-1240-0-avatar-profile-icon-png.png{% endif %}" alt="User profile picture" class="profile-picture" />
                    <h2 class="username">{{ profile.name|title }}</h2>
                    <p class="user-email">{{ user.username }}</p>
                    <nav>
                        <ul class="nav-menu">
                            <li class="nav-item"><a href="{% url 'home' %}">Dashboard</a></li>
                            <li class="nav-item"><a href="{% url 'all_expenses' %}">Expenses</a></li>
                            <li class="nav-item"><a href="{% url 'Stock_prediction' %}">Stock Predictor</a></li>
                            <li class="nav-item"><a href="{% url 'expenses_summary' %}">Summary</a></li>
                            <li class="nav-item"><a href="{% url 'statement_upload' %}">Upload Statement</a></li>
                            <li class="nav-item"><a href="{% url 'details_form' %}">Settings</a></li>
                            <li class="nav-item"><a href="{% url 'logout' %}">Log Out</a></li>
                        </ul>
                    </nav>
                </div>
            </aside>
            <main class="main-content">
                <div class="content-wrapper">
                    <div class="content-layout">
                        <section class="expenses-section">
                            <header class="expenses-header">
                                <div class="header-text">
                                    <h1 class="expenses-title">Expenses</h1>
                                    <div class="dropdown-container">
                                        <label for="year-select">Select Year:</label>
                                        <select id="year-select">
                                            <!-- Options will be populated dynamically -->
                                        </select>
                                    </div>
                                    <p class="expenses-date">01 - 25 March, 2020</p>
                                </div>
                            </header>
                            <div class="expenses-chart-container">
                                <canvas id="expensesChart" class="expenses-chart"></canvas>
                            </div>
                            <div class="expenses-list">
                                <div class="expenses-layout">
                                    <div class="expenses-items">
                                        <!-- The content here will be dynamically generated by JavaScript -->
                                    </div>
                                    <div class="expenses-amounts">
                                        <!-- Optional: if you have specific amounts to display outside the dynamic list -->
                                    </div>
                                </div>
                            </div>
                            
                        </section>
                        <aside class="sidebar-content">
                            <h2 class="sidebar-title">Where your money go?</h2>
                            <div class="sidebar-money"></div>
                        </aside>
                    </div>
                </div>
            </main>
        </div>
    </section>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded and parsed');
        
            fetch('/csv-data/')
                .then(response => {
                    console.log('Received response from /csv-data/');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Data received:', data);
        
                    if (data.error) {
                        console.error('Error in data:', data.error);
                        document.querySelector('.no-data-message').style.display = 'block';
                        return;
                    }
        
                    const years = data.years;
                    populateYearSelect(years);
        
                    const yearSelect = document.getElementById('year-select');
                    yearSelect.addEventListener('change', function() {
                        const selectedYear = this.value;
                        updateDataForYear(selectedYear, data);
                    });
        
                    const latestYear = years[years.length - 1];
                    yearSelect.value = latestYear;
                    updateDataForYear(latestYear, data);
        
                    function populateYearSelect(years) {
                        const yearSelect = document.getElementById('year-select');
                        years.forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year;
                            yearSelect.appendChild(option);
                        });
                    }
        
                    function updateDataForYear(year, data) {
                        const filteredData = data.data.filter(row => new Date(row.date).getFullYear().toString() === year);
                        const chartData = processChartData(filteredData, year);
        
                        const ctx = document.getElementById('expensesChart').getContext('2d');
                        if (window.myChart) {
                            window.myChart.destroy();
                        }
                        window.myChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: chartData.labels,
                                datasets: [{
                                    label: 'Monthly Expenses',
                                    data: chartData.data,
                                    backgroundColor: 'rgba(75, 192, 192, 0.8)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1,
                                    borderRadius: 6
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(tooltipItem) {
                                                return `Total: Rs ${tooltipItem.raw.toFixed(2)}`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        display: false,
                                    },
                                    y: {
                                        display: false,
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
        
                        const latestMonthYear = chartData.labels[chartData.labels.length - 1];
                        updateExpensesList(latestMonthYear, filteredData);
                        document.querySelector('.expenses-date').textContent = latestMonthYear;
                        updateSidebar(filteredData);
        
                        ctx.canvas.addEventListener('click', function(event) {
                            const activePoints = window.myChart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                            if (activePoints.length) {
                                const index = activePoints[0].index;
                                const monthYear = chartData.labels[index];
                                updateExpensesList(monthYear, filteredData);
                                document.querySelector('.expenses-date').textContent = monthYear;
                                updateSidebar(filteredData);
                            }
                        });
                    }
        
                    function processChartData(data, year) {
                        console.log('Processing chart data...');
                        const monthlyData = {};
                        const monthYears = getMonthYears(year);
        
                        monthYears.forEach(monthYear => {
                            monthlyData[monthYear] = 0; // Initialize all months to 0
                        });
        
                        data.forEach(row => {
                            const monthYear = formatDate(row.date);
                            if (monthYear) {
                                monthlyData[monthYear] += parseFloat(row.amount) || 0;
                            }
                        });
        
                        const dataArray = monthYears.map(monthYear => monthlyData[monthYear] || 0);
        
                        console.log('Chart data processed:', { labels: monthYears, data: dataArray });
                        return {
                            labels: monthYears,
                            data: dataArray
                        };
                    }
        
                    function updateExpensesList(monthYear, data) {
                        console.log('Updating expenses list for month:', monthYear);
                        const expensesItems = document.querySelector('.expenses-items');
        
                        const filteredData = data.filter(row => {
                            const rowMonthYear = formatDate(row.date);
                            return rowMonthYear === monthYear;
                        });
        
                        const groupedByDate = filteredData.reduce((acc, row) => {
                            const date = row.date;
                            if (!acc[date]) {
                                acc[date] = [];
                            }
                            acc[date].push(row);
                            return acc;
                        }, {});
        
                        const sortedDates = Object.keys(groupedByDate)
                            .sort((a, b) => new Date(b) - new Date(a))
                            .slice(0, 3);
        
                        let itemsHtml = `<h3 class="expense-date">${monthYear} Expenses</h3>`;
        
                        const categoryImages = {
                            'Groceries': 'https://cdn.builder.io/api/v1/image/assets/TEMP/788be02310a788361d7f2052f994ccfe7f4519b49463667de46049fe7063cdc4?apiKey=cde7e7547a684a3987bb76406156bbc5&',
                            'Transportation': 'https://cdn.builder.io/api/v1/image/assets/TEMP/0f05fda9df7128a3aef111a31078fe024f6c9013fcf10bf9c6586e5355fa1c9d?apiKey=cde7e7547a684a3987bb76406156bbc5&',
                            'Utilities': 'https://clipground.com/images/utility-icon-png-5.png',
                            'Entertainment': 'https://cdn.builder.io/api/v1/image/assets/TEMP/1891006e39ee01be8bc048b5b86c75de85e9964247dc2f753babde769afffb6d?apiKey=cde7e7547a684a3987bb76406156bbc5&',
                            'FOOD': 'https://cdn.builder.io/api/v1/image/assets/TEMP/47d758dafd688a3683fbed10b6253d2a20ced73f1157d99ba1626c8f7209dfe0?apiKey=cde7e7547a684a3987bb76406156bbc5&',
                            'SHOPPING': 'https://cdn.iconscout.com/icon/free/png-512/shopping-cart-442-1151214.png',
                            'Rent': 'https://cdn.builder.io/api/v1/image/assets/TEMP/ef7fa8b2cd39093a7758b568ddfbf819ba700145e21ab08ae5653a3d6fbe0af7?apiKey=cde7e7547a684a3987bb76406156bbc5&',
                            'Health & Fitness' : 'https://cdn2.iconfinder.com/data/icons/limitless/128/fitness-run-sport-trainer-1024.png'
                        };
        
                        sortedDates.forEach(date => {
                            const transactions = groupedByDate[date];
                            transactions.forEach(row => {
                                const imageUrl = categoryImages[row.category] || 'https://cdn3.iconfinder.com/data/icons/accounting-37/64/business-transaction-payment-money-trade-512.png';
                                itemsHtml += `
                                    <div class="expense-item">
                                        <img src="${imageUrl}" alt="${row.category} icon" class="expense-icon" />
                                        <div class="expense-details">
                                            <h4 class="expense-category">${row.category}</h4>
                                            <p class="expense-description">${row.description}</p>
                                        </div>
                                        <p class="expense-amount">Rs ${parseFloat(row.amount).toFixed(2)}</p>
                                    </div>
                                `;
                            });
                        });
        
                        expensesItems.innerHTML = itemsHtml;
                    }
        
                    function updateSidebar(data) {
                        console.log('Updating sidebar...');
                        const categoryTotals = {};
                        let totalExpenses = 0;
        
                        data.forEach(row => {
                            const category = row.category;
                            const amount = parseFloat(row.amount);
                            if (!categoryTotals[category]) {
                                categoryTotals[category] = 0;
                            }
                            categoryTotals[category] += amount;
                            totalExpenses += amount;
                        });
        
                        const sidebar = document.querySelector('.sidebar-money');
                        sidebar.innerHTML = '';
        
                        // Convert categoryTotals to an array of [category, amount] pairs
                        const sortedCategoryTotals = Object.entries(categoryTotals)
                            .sort((a, b) => b[1] - a[1]); // Sort in descending order by amount
        
                        sortedCategoryTotals.forEach(([category, amount]) => {
                            const percentage = (totalExpenses > 0) ? ((amount / totalExpenses) * 100).toFixed(2) : 0;
        
                            sidebar.innerHTML += `
                                <div class="expense-category-item">
                                    <span class="category-name">${category}</span>
                                    <span class="category-amount">Rs ${amount.toFixed(2)} (${percentage}%)</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${percentage}%;"></div>
                                </div>
                            `;
                        });
        
                        sidebar.innerHTML += `
                            <div class="savings-tip">
                                <div class="tip-icons">
                                    <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/e322e44e007117927441ee60f0d5a0beb5d36970c1400a1a5de26606a1d12a77?apiKey=cde7e7547a684a3987bb76406156bbc5&" alt="Savings tip icon left" class="tip-icon-left" />
                                    <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/666d084afea2cbcb52b976f17a00fc47ac718c8ab636c42bc83a83a43200be5b?apiKey=cde7e7547a684a3987bb76406156bbc5&" alt="Savings tip icon right" class="tip-icon-right" />
                                </div>
                                <h3 class="tip-title">Save more money</h3>
                                <p class="tip-description">Empower Your Savings: Track, Analyze, and Optimize Your Expenses.</p>
                                <button class="tip-button">VIEW TIPS</button>
                            </div>
                        `;
                    }
        
                    function formatDate(dateString) {
                        const validFormats = [
                            'DD-MM-YYYY', 'MM-DD-YYYY', 'YYYY-MM-DD',
                            'D-M-YYYY', 'M-D-YYYY', 'YYYY-M-D'
                        ];
                        const date = moment(dateString, validFormats, true);
                        if (date.isValid()) {
                            return date.format('MMM YYYY');
                        }
                        console.warn(`Invalid date format: ${dateString}`);
                        return null;
                    }
        
                    function getMonthYears(year) {
                        const monthYearsSet = new Set();
                        for (let month = 0; month < 12; month++) {
                            const date = new Date(year, month, 1);
                            const monthYear = moment(date).format('MMM YYYY');
                            monthYearsSet.add(monthYear);
                        }
                        return Array.from(monthYearsSet).sort((a, b) => new Date(a) - new Date(b));
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    document.querySelector('.no-data-message').style.display = 'block';
                });
        });
    </script>
    
</body>
</html>        